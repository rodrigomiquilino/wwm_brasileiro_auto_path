# Recebe solicita√ß√£o de renomea√ß√£o de vari√°vel do reposit√≥rio wwm_brasileiro
# e atualiza o pt-br.tsv na branch dev
#
# REPOSIT√ìRIO: wwm_brasileiro_auto_path
# IMPORTANTE: Coloque este arquivo em wwm_brasileiro_auto_path/.github/workflows/

name: Rename Variable

on:
  repository_dispatch:
    types: [rename-variable]

# ========== FILA AUTOM√ÅTICA ==========
# Evita conflitos quando v√°rias renomea√ß√µes s√£o feitas em sequ√™ncia
concurrency:
  group: rename-variable-queue
  cancel-in-progress: false

jobs:
  rename:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0
      
      - name: Display rename info
        run: |
          echo "üîÑ Renomeando vari√°vel..."
          echo "   DE: ${{ github.event.client_payload.old_var }}"
          echo "PARA: ${{ github.event.client_payload.new_var }}"
      
      - name: Rename variable in pt-br.tsv
        run: |
          OLD_VAR="${{ github.event.client_payload.old_var }}"
          NEW_VAR="${{ github.event.client_payload.new_var }}"
          
          # Conta ocorr√™ncias antes
          COUNT_BEFORE=$(grep -o "$OLD_VAR" pt-br.tsv | wc -l)
          echo "üìä Ocorr√™ncias encontradas: $COUNT_BEFORE"
          
          # Substitui
          sed -i "s/$OLD_VAR/$NEW_VAR/g" pt-br.tsv
          
          # Conta ocorr√™ncias depois (deve ser 0)
          COUNT_AFTER=$(grep -o "$OLD_VAR" pt-br.tsv | wc -l)
          echo "‚úÖ Substitui√ß√µes feitas: $((COUNT_BEFORE - COUNT_AFTER))"
      
      - name: Check for changes
        id: git-check
        run: |
          git diff --quiet pt-br.tsv && echo "changed=false" >> $GITHUB_OUTPUT || echo "changed=true" >> $GITHUB_OUTPUT
      
      - name: Commit changes
        if: steps.git-check.outputs.changed == 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add pt-br.tsv
          git commit -m "üîÑ Renomear vari√°vel: ${{ github.event.client_payload.old_var }} ‚Üí ${{ github.event.client_payload.new_var }}

          Disparado via glossary-admin por @${{ github.event.client_payload.triggered_by }}"
          
          # ========== PUSH COM RETRY ==========
          for attempt in 1 2 3; do
            echo "üì§ Tentativa $attempt de push..."
            git pull --rebase origin dev 2>/dev/null || true
            if git push origin dev; then
              echo "‚úÖ Push realizado com sucesso!"
              break
            else
              if [ $attempt -lt 3 ]; then
                echo "‚ö†Ô∏è Falha no push, aguardando $((attempt * 2))s..."
                sleep $((attempt * 2))
              else
                echo "‚ùå Falha ap√≥s 3 tentativas"
                exit 1
              fi
            fi
          done
      
      - name: No changes needed
        if: steps.git-check.outputs.changed == 'false'
        run: |
          echo "‚ÑπÔ∏è Nenhuma ocorr√™ncia de ${{ github.event.client_payload.old_var }} encontrada no arquivo."

